name: sdd-validate-impl
description: SDD Phase 5 - 実装が要件・設計・タスクに合致しているかを検証する。不合格時は自動修正→再検証ループ
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 15
initial_movement: validate

instructions:
  validate-impl: ../instructions/validate-impl.md
  fix-impl: ../instructions/fix-impl.md

report_formats:
  sdd-impl-validation: ../output-contracts/sdd-impl-validation.md

loop_monitors:
  - cycle:
      - validate
      - fix-impl
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        検証・修正サイクルが {cycle_count} 回繰り返されました。

        **参照するレポート:**
        - アーキテクチャレビュー: {report:05-architect-review.md}
        - QAレビュー: {report:06-qa-review.md}
        - 実装検証: {report:07-impl-validation.md}

        **判断基準:**
        - 各サイクルで新しい問題が発見・修正されているか
        - 同じ指摘が繰り返されていないか
      rules:
        - condition: 健全（進捗あり）
          next: fix-impl
        - condition: 非生産的（改善なし）
          next: ABORT

movements:
  - name: validate
    parallel:
      - name: arch-review
        edit: false
        persona: architecture-reviewer
        policy: review
        knowledge:
          - architecture
          - backend
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction: review-arch
        output_contracts:
          report:
            - name: 05-architect-review.md
              format: architecture-review
        rules:
          - condition: approved
          - condition: needs_fix

      - name: qa-review
        edit: false
        persona: qa-reviewer
        policy:
          - review
          - qa
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction: review-qa
        output_contracts:
          report:
            - name: 06-qa-review.md
              format: qa-review
        rules:
          - condition: approved
          - condition: needs_fix

      - name: impl-validation
        edit: false
        persona: supervisor
        policy: review
        allowed_tools:
          - Read
          - Glob
          - Grep
          - Bash
        instruction: validate-impl
        output_contracts:
          report:
            - name: 07-impl-validation.md
              format: sdd-impl-validation
        rules:
          - condition: 検証合格
          - condition: 検証不合格

    rules:
      - condition: all("approved", "approved", "検証合格")
        next: COMPLETE
      - condition: any("needs_fix", "検証不合格")
        next: fix-impl

  - name: fix-impl
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    knowledge:
      - backend
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    instruction: fix-impl
    rules:
      - condition: 修正完了
        next: validate
      - condition: 判断できない、情報不足
        next: ABORT
